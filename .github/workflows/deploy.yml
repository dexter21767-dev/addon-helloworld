name: Deploy to Beamup

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Validate secrets
        run: |
          if [ -z "${{ secrets.SSH_PRIVATE_KEY }}" ]; then
            echo "Error: SSH_PRIVATE_KEY secret is not set"
            exit 1
          fi
          if [ -z "${{ secrets.BEAMUP_HOST }}" ]; then
            echo "Error: BEAMUP_HOST secret is not set"
            exit 1
          fi
          if [ -z "${{ secrets.USERNAME_GITHUB }}" ]; then
            echo "Error: USERNAME_GITHUB secret is not set"
            exit 1
          fi
          if [ -z "${{ secrets.PROJECT_NAME }}" ]; then
            echo "Error: PROJECT_NAME secret is not set"
            exit 1
          fi
          echo "All required secrets are configured âœ“"
      
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
        
      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          
          # Add the sync-github-keys private key
          echo "LS0tLS1CRUdJTiBPUEVOU1NIIFBSSVZBVEUgS0VZLS0tLS0KYjNCbGJuTnphQzFyWlhrdGRqRUFBQUFBQkc1dmJtVUFBQUFFYm05dVpRQUFBQUFBQUFBQkFBQUJGd0FBQUFkemMyZ3RjbgpOaEFBQUFBd0VBQVFBQUFRRUF0eC85MVZGYzNCb0xCS2pIU1V0RmNnOHRDcE1NK2M4c2VjOFNtRTVaRWxsd3lNY2VaY3JWCklOQzV4OUl6K1RJU05LZnJldFhGQjlIKzNWRTI3RnFRbFd3SXM5U0VsMkd6QSs3L2dRaE1DcktRWTNiWTBXZkJ4eUZlNFQKQW9VcXJadTQ2M25KWnBZZ0lGRDJtbHphZTViNTljTUNveWpsZVpMczA3NURuNmkranlrWmxwUFFISXp0NkdsdUdvd0VEagpwMklqYkt2SXRDaVoxV0pOUjJZWm9NbDdpL2RaMlFpMlhEU0xmRWQ3VGxwTnBnYms1SmJ5REtoUm53WCtycEFwN1JCbE5wCldXelJHVjFEVVVpRlJ6WjFXeXNvU3VId3l0c3l4S0J5NE54VzV0SzV4U3didCt2cEdRcGx2K01xVWVPbE5NVGcvRXJIY2MKd1BKYzdydlJHd0FBQTlpYU05N2xtalBlNVFBQUFBZHpjMmd0Y25OaEFBQUJBUUMzSC8zVlVWemNHZ3NFcU1kSlMwVnlEeQowS2t3ejV6eXg1enhLWVRsa1NXWERJeHg1bHl0VWcwTG5IMGpQNU1oSTBwK3Q2MWNVSDBmN2RVVGJzV3BDVmJBaXoxSVNYClliTUQ3ditCQ0V3S3NwQmpkdGpSWjhISElWN2hNQ2hTcXRtN2pyZWNsbWxpQWdVUGFhWE5wN2x2bjF3d0tqS09WNWt1elQKdmtPZnFMNlBLUm1XazlBY2pPM29hVzRhakFRT09uWWlOc3E4aTBLSm5WWWsxSFpobWd5WHVMOTFuWkNMWmNOSXQ4UjN0TwpXazJtQnVUa2x2SU1xRkdmQmY2dWtDbnRFR1UybFpiTkVaWFVOUlNJVkhOblZiS3loSzRmREsyekxFb0hMZzNGYm0wcm5GCkxCdTM2K2taQ21XLzR5cFI0NlUweE9EOFNzZHh6QThsenV1OUViQUFBQUF3RUFBUUFBQVFCbnA0d2VldmQ4L3FETitsc1QKZWEvTmFCbXVxcDNscVFjYnk4SlN3OFpYUkprNmpMc0FFMWVnUTRWbFBlNTlWNEpHbStZR21ZbjFhMEJBTmdCSXVOcXVPWQpDVGllK2pZSUhiOENSZi9UcE5zOVZXOTZheW9YQm1MdFZ0MGJ5QlRvUUFUa0JRT2pOY2JwZytxU1pZeWwrRWQwZlBXNU5TClR2TStNcDE4Q2ZWdnkyNEsxRnhHZmNXaFlsZm03NnNCRk9ha2ZqaVk2SGV2WGdSVisrUUFGQU5Sc1lHS2FQWXVUU1pMeEgKTlpPYWxlNUNhNmF4dzA1TCtjdmZFRzU2VWZvYTUrWHo1b0I2aHJJWXk3UnpUcmw3R2ZweCtvdWsxdDZ1eE1Na0tHZzdZdAo3eitLb2UrSm4xZnNHZHpiVHlUVGZ3Z01adGlha1VzYkNwRWJLQlRQa25TQkFBQUFnRnc3eW9tU0ttS2FJK09uWFVBVzJzClkxbjVXc3J6UWNWNnVLSlJzNHpnYnVua1lSV0ZPQnlWNTZDN29xU01FeXdvTGRwSENoek9UVlE0aStCcDI2Lys5WmdNMjIKMGRkUkhxSkZDYnoxa3RKWTVScm1qeUVYdzFvZXdNN0ZINEhDMWRLdkxKMUd4Ry92eTVKaFNhL0VVUWtTa3lkQ1NtVGUxaQptRlYxNUpEVURkQUFBQWdRRG9PTE9RaFlacytoYVdUOW1ibmhBNk0xY3ZxaTIycm00NjRIRS9wTUF0WkYxTmd6aS9NMmlVClIvUnE3SWVvZWE2WklxQzY2dE1WZ1FFUnozQUhPT01nRzB3UFFwZHBWTUF5OFpTQlcyUnRSSjVMM1BxSUROczhOc1ZvUGUKaTI3YzdlTWNmOGxiUjlRNzNhUkN1U1A3MFJLbEhZYmtCemFibkwvWWFIOEp6a2FRQUFBSUVBeWVCT2h2MHlFYkZJU2Q4VAoyam44UlhZM3NOcUFLZ24rc1dqOHpJU0JJWGp6MittbEppbTNMYXFlVVgzd0RycE1ZSTAybzZkL2w5czVueEVPMkRlRkZLClBMVUcveXpUa1hUdXY4UmpJMHFyY3FkY3ZyZmtySGJhN0MrbGsxNTEyaGtEdVNkVmNLemZKbFBBRzJoVy9RMXRNUVJPSGwKQjcreEI5bGl4ekZxQ09NQUFBQWVZMjl1ZEhKdmJFQnpkSEpsYldsdkxXRmtaRzl1TFdSbGNHeHZlV1Z5QVFJREJBVT0KLS0tLS1FTkQgT1BFTlNTSCBQUklWQVRFIEtFWS0tLS0t" | base64 -d > ~/.ssh/sync_key
          chmod 600 ~/.ssh/sync_key
          
          ssh-keyscan -H ${{ secrets.BEAMUP_HOST }} >> ~/.ssh/known_hosts
      
      - name: Sync GitHub keys with Beamup
        run: |
          ssh -i ~/.ssh/sync_key dokku@${{ secrets.BEAMUP_HOST }} sync-github-keys ${{ secrets.USERNAME_GITHUB }}

      - name: Generate username hash
        id: hash
        run: |
          # Convert username to lowercase and add newline, then hash
          GITHUB_USER_HASHED=$(echo "${{ secrets.USERNAME_GITHUB }}" | awk '{print tolower($0)}' | shasum -a 256 | cut -c1-12 )
          echo "username_hashed=${GITHUB_USER_HASHED}" >> $GITHUB_OUTPUT
          echo "Generated username hash: ${GITHUB_USER_HASHED}"
          
      - name: Configure Git and Deploy
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          
          git remote add beamup dokku@${{ secrets.BEAMUP_HOST }}:${{ steps.hash.outputs.username_hashed }}/${{ secrets.PROJECT_NAME }} || true
          git push beamup HEAD:master --force
          
      - name: Cleanup
        if: always()
        run: |
          rm -f ~/.ssh/id_rsa
